# Implementation Plan

## Tasks

- [x] 1. TTYダッシュボード基盤（端末制御・装飾・整形）を共通化する
- [x] 1.1 (P) 端末能力判定とフォールバック（TTY/NO_COLOR等）を実装する
  - TTYでない場合は自動的にダッシュボードを無効化し、通常ログへフォールバックする
  - 色/太字など装飾が無効な環境（NO_COLORやTERM条件）でも読みやすいプレーン表示にする
  - _Requirements: 4.5, 8.6_
- [x] 1.2 (P) 装飾（色/太字/薄色）の統一ルールを実装する
  - ステータス（connected/reconnecting/disconnected、NORMAL/DEFENSIVE/PAUSE）を色で区別する
  - BUY/SELL（BID/ASK）を色で区別しつつ、テキストでも判別できる表現にする
  - stale/異常（遅延、reject、再接続等）を強調表示できるようにする
  - _Requirements: 8.1, 8.2, 8.3, 8.4_
- [x] 1.3 (P) レイアウト整形（列幅固定・桁揃え・単位統一）を実装する
  - 数値の桁揃え、単位の統一、固定幅カラムを提供して横揺れを抑制する
  - 複数シンボル表示を想定し、可読性維持のための一覧/ページング戦略を用意する（最小は一覧）
  - _Requirements: 6.3, 8.5_
- [x] 1.4 端末の開始/終了（alternate screen・カーソル復帰）を安全に実装する
  - 開始時にスクロールバックを破壊せず、終了時に必ず端末状態を復帰する
  - SIGINT/SIGTERM/exitでの復帰を保証する
  - _Requirements: 5.3, 6.2_

- [x] 2. 差分描画（ちらつき防止）レンダラを実装する
- [x] 2.1 フレームの差分を取り、変更行のみを更新する
  - 同一フレームが連続する場合は無駄な再描画を抑制する
  - 行の増減にも耐える（未使用行のクリア、表示崩れ防止）
  - _Requirements: 4.1, 4.3, 8.5_
- [x] 2.2 描画周期をスロットリングし、ホットパスをブロックしない設計にする
  - データ更新頻度と描画頻度を分離し、一定周期で滑らかに更新する
  - 描画処理が受信/意思決定処理の遅延原因にならないようにする
  - _Requirements: 4.2, 4.4_

- [x] 3. ログをダッシュボード内に統合し、出力競合を根絶する
- [x] 3.1 (P) ログをリングバッファで保持し、直近N件を取得できるようにする
  - レベル別に表示を変え、重要ログ（WARN/ERROR）を視認しやすくする
  - _Requirements: 5.2, 9.6_
- [x] 3.2 (P) ログ出力を “コンソール” と “ダッシュボード” にルーティングできるようにする
  - ダッシュボード有効時はログをUI内ログ領域へ送ってstdoutと衝突させない
  - ダッシュボード無効時は従来のコンソール出力を維持する
  - _Requirements: 5.1, 9.5_
- [x] 3.3 ダッシュボードのログ領域（ペイン）を実装する
  - 直近N件のログを時刻・レベル付きで表示する
  - NO_COLOR時でも判別可能な表示にする
  - _Requirements: 9.5, 9.6, 8.1, 8.4, 8.6_

- [x] 4. フロー（フェーズ）可視化を実装する
- [x] 4.1 (P) executor のフェーズ状態（READ/DECIDE/PLAN/EXECUTE/PERSIST/IDLE）を追跡できるようにする
  - フェーズ遷移時刻と直近所要時間（または経過時間）を保持できるようにする
  - _Requirements: 9.1, 9.3_
- [x] 4.2 (P) ingestor のフェーズ状態（CONNECTING/SUBSCRIBED/RECEIVING/FLUSHING/IDLE）を追跡できるようにする
  - フェーズ遷移時刻と直近所要時間（または経過時間）を保持できるようにする
  - _Requirements: 9.2, 9.3_
- [x] 4.3 ダッシュボード上で現在フェーズと経過を表示する
  - stuck/quietの判別ができるように、フェーズのageや直近durationを表示する
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 5. ingestor ダッシュボードの表示モデルと表示内容を実装/統合する
- [x] 5.1 (P) ingestor の最新状態スナップショットを構築し、欠損を明示できるようにする
  - 接続状態と鮮度（age）を明示する
  - ストリーム種別ごとの最終更新を表示できるようにする
  - _Requirements: 1.2, 1.4, 2.1, 2.2_
- [x] 5.2 (P) ingestor の市場データ表示（BBO/mark/index）を整備する
  - 対象シンボルのBBO（bid/ask/mid/spread）を表示する
  - mark/indexが存在する場合は併記する
  - stale時は強調表示する
  - _Requirements: 2.3, 2.4, 2.6, 8.4_
- [x] 5.3 (P) ingestor の健全性指標（受信レート、バッファ、間引き判断）を表示する
  - msg/sなどのレートと、間引きの判断理由を可視化する
  - _Requirements: 2.5_
- [x] 5.4 ingestor の表示を差分描画・ログ統合・装飾基盤に載せ替える
  - 表示がちらつかず、他ログと競合しないことを保証する
  - _Requirements: 4.1, 4.2, 4.3, 5.1, 9.5, 9.6_

- [x] 6. executor ダッシュボードの表示モデルと表示内容を実装/統合する
- [x] 6.1 (P) executor の最新状態スナップショットを構築し、欠損を明示できるようにする
  - DEXの最新データ（BBO/mark/index）と鮮度（age）を表示できるようにする
  - _Requirements: 1.2, 1.4, 3.2, 9.4_
- [x] 6.2 (P) executor の戦略状態（mode/reasons/intents）とPAUSE表示を整備する
  - NORMAL/DEFENSIVE/PAUSE と遷移理由を表示する
  - PAUSE時は “板を出していない” ことが一目で分かる表示にする
  - _Requirements: 3.1, 3.6, 8.2, 8.4_
- [x] 6.3 (P) executor の注文・ポジションを表示する
  - アクティブ注文（side/price/size/id/age）を表示する
  - ポジション（size/entry/uPnL/age）を表示する
  - _Requirements: 3.3, 3.4_
- [x] 6.4 (P) executor の直近イベント（fills/注文イベント）を表示する
  - 直近少数件のイベントを表示し、reject等を強調する
  - _Requirements: 3.5, 5.2, 8.4_
- [x] 6.5 executor の表示を差分描画・ログ統合・装飾基盤に載せ替える
  - 表示がちらつかず、他ログと競合しないことを保証する
  - _Requirements: 4.1, 4.2, 4.3, 5.1, 9.5, 9.6_

- [x] 7. ダッシュボードの有効化・操作性を仕上げる
- [x] 7.1 ダッシュボードの有効/無効を外部から制御できるようにする
  - 実行時に明示的に有効/無効化できる
  - _Requirements: 1.1, 6.1_
- [x] 7.2 更新頻度（refresh interval）を設定可能にする
  - 高頻度入力でも描画はスロットリングされる
  - _Requirements: 4.2_

- [x] 8. テストを追加し、表示品質とログ統合を固定する
- [x] 8.1 (P) 差分描画レンダラのユニットテストを追加する
  - 同一フレーム連続で無駄な更新が出ないことを検証する
  - 行の増減時に表示崩れが起きないことを検証する
  - _Requirements: 4.1, 4.3, 7.1_
- [x] 8.2 (P) フェーズ追跡（フロー）状態のユニットテストを追加する
  - フェーズ遷移時刻とdurationが正しく更新されることを検証する
  - _Requirements: 7.1, 9.1, 9.2, 9.3_
- [x] 8.3 (P) ログルーティング/ログリングバッファのユニットテストを追加する
  - UI有効時にログがUI側へ流れることを検証する
  - 直近N件のみ保持されることを検証する
  - _Requirements: 7.1, 9.5, 9.6_
- [x] 8.4 ダッシュボード統合テストを追加する
  - ダッシュボード有効時に stdout とログ出力が衝突しないことを検証する
  - TTYでない場合にフォールバックすることを検証する
  - _Requirements: 4.5, 5.1, 7.2_

- [x] 9. 受入条件（長時間安定表示）を満たすことを確認できる仕組みを追加する
- [x] 9.1 長時間（10分）連続稼働で表示が崩れないことを検証できるようにする
  - 高頻度イベントとログ発生があっても、画面がちらつかず更新が継続することを確認できるようにする
  - _Requirements: 7.3_
